#!/bin/bash
if [ -d "{{ runDir }}" ] && [ -n "$(ls -A {{ runDir }})" ]; then
    for f in '{{ pyFileName }}' run_parallel_python.py; do
        rm -f "{{ runDir }}/$f"
    done
fi
run_rsopt="rsopt sample configuration '{{ ymlFileName }}'"
echo Running $run_rsopt...
eval "$run_rsopt" > "{{ outFileName }}" 2>&1
if [ $? -eq 0 ]
then
    run_py="python '{{ pyFileName }}' rsopt_run '{{ fileBase }}.npy'"
    read -p "Continue? (** will run SRW {{ totalSamples }} times **)? (Y/N): " confirm
    if [[ $confirm == [yY] ]]; then
        echo Running SRW...
        if eval "$run_py"; then
            echo Propagated single electron intensities are in datasets/beam_intensities.npy
            echo Corresponding parameter values are in datasets/parameters.npy
        else
            echo "ERROR: SRW failed with return code $?"
        fi
    else
        echo "NOTE: to run SRW with generated data, use
        $run_py"
    fi
else
    echo "ERROR: rsopt failed with return code $?, see {{ outFileName }}"
    exit 99
fi
