from distgen import Generator
from impact import Impact
import impact.parsers
import pykern.pkio
import shutil

files = dict(
    input_to_id={},
    next_input=1,
)

def prep_input_file(filename):
    if filename not in files['input_to_id']:
        n = f"rfdata{files['next_input']}"
        files['next_input'] += 1
        shutil.copy(filename, n)
        files['input_to_id'][filename] = n
    return files['input_to_id'][filename]

{% if distgenYAML %}
G = Generator('''
{{ distgenYAML }}
''')
G.run()
{% endif %}

I = Impact(
    use_temp_dir=False,
    workdir=".",
    timeout=1e6,
{% if distgenYAML %}
    initial_particles=G.particles,
{% endif %}
)
I.header.update({
{% for k in impactHeader %}
    "{{k}}": {{impactHeader[k]}},
{% endfor %}
})
del I.lattice[:]
I.lattice.extend([
{% for v in lattice %}
    dict(
        {{ v | indent(8) }}    ),
{% endfor %}
])

{% if numProcs > 1 %}
I.numprocs = {{ numProcs }}
{% endif %}

{% if distributionFilename %}
shutil.copy("{{distributionFilename}}", "partcl.data")
with pykern.pkio.open_text("{{distributionFilename}}") as f:
    I.header["Np"] = int(f.readline())
{% endif %}

try:
    I.run()

    for k in I.output["particles"]:
        I.output["particles"][k].write(f"{k}.h5")
except Exception as e:
    print(I.log)
    raise e
print(I.log)
