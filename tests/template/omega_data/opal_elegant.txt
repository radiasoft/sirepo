#!/usr/bin/env python

from pmd_beamphysics import pmd_init
from pykern import pkio
from rslume import Elegant, OPAL, Genesis2
import h5py
import numpy
import os

# patch numpy
numpy.float = float


def run_and_save_particles(sim):
    pkio.mkdir_parent(sim.workdir)
    sim.run()
    p = sim.final_particles()
    if p:
        with h5py.File(os.path.join(sim.workdir, "openpmd.h5"), "w") as f:
            pmd_init(f, basePath="/", particlesPath="/" )
            p.write(f)
    return sim


run1 = run_and_save_particles(
    OPAL(
        input_file="run1/opal.in",
        use_temp_dir=False,
        workdir="run1/out",
        initial_particles=None,
        update_filenames=True,
    ),
)

run2 = run_and_save_particles(
    Elegant(
        input_file="run2/elegant.ele",
        use_temp_dir=False,
        workdir="run2/out",
        initial_particles=run1.final_particles(),
        update_filenames=True,
    ),
)

